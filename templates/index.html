<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Temperature and Humidity Data</title>

    <script src="https://cdn.plot.ly/plotly-2.18.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header>
    Office Dashboard
    
    <img src="{{ url_for('static', filename='duck.png') }}" height="30px">
</header>

<div class="info-container">
    <div class="info">
        <h2>Office Conditions</h2>
        <p>Current Temperature: <span id="currentTemperature">--</span> ¬∞C</p>
        <p>Average Temperature (Last 5 minutes): <span id="averageTemperature5Min">--</span> ¬∞C</p>
        <p>Average Temperature (Last 5 days): <span id="averageTemperature5Days">--</span> ¬∞C</p>
    </div>

    <div class="bus-info">
        <h2>Next Campus Linc Bus at LAC</h2>
        <p id="next-departure">Loading next departure...</p>
        <p id="next-arrival">Loading next arrival...</p>
        <div class="macice-status">
            <h2 style="margin-top: 0.25rem; margin-bottom: 0.25rem">mc-status</h2>
            <p>Ruston Road: <code id="macice-p-rust" class="mcice-unknown">unknown</code></p>
            <p>13/14 Cornhill: <code id="macice-p-cor"  class="mcice-unknown">unknown</code></p>
            <p>323 High Street: <code id="macice-p-hs"   class="mcice-unknown">unknown</code></p>
            <p>The Carlton Centre: <code id="macice-p-carl" class="mcice-unknown">unknown</code></p>
            <p>Moorland Close: <code id="macice-p-moor" class="mcice-unknown">unknown</code></p>
        </div>
    </div>

    <div class="info">
        <h2>Latest BBC News</h2>
        <ul id="bbcNewsList"></ul>
    </div>

    <!-- <div class="info" id="departuresInfo">
        <h2>Latest Departures from Humberside Airport</h2>
        <ul id="departuresList">
            <li>Loading departures...</li>
        </ul>
    </div> -->

    <div class="info" id="weatherInfo">
        <h2>Weather Information</h2>
        <p>Loading weather data...</p>
    </div>

    <div class="info" id="gone-pub" style="display: none; text-align: center; font-size: 2em; padding: 20px;">
        Gone Pub üçª
    </div>
</div>

<div class="container">
    <div class="chart-container" id="temperatureChart"></div>
    <div class="chart-container" id="humidityChart"></div>
</div>

<footer>
    &copy; 2024 Duck Ltd.
    
    <img src="{{ url_for('static', filename='duck.png') }}" height="15px">
</footer>

<script>
    const socket = io();

    // Initialize Plotly charts
    const temperatureLayout = {
        title: 'Temperature (¬∞C)',
        xaxis: { title: 'Time' },
        yaxis: { title: 'Temperature (¬∞C)' },
        margin: { t: 50, r: 30, l: 50, b: 50 }
    };
    const humidityLayout = {
        title: 'Humidity (%)',
        xaxis: { title: 'Time' },
        yaxis: { title: 'Humidity (%)' },
        margin: { t: 50, r: 30, l: 50, b: 50 }
    };

    Plotly.newPlot('temperatureChart', [{ x: [], y: [], mode: 'lines', line: { color: 'red' } }], temperatureLayout);
    Plotly.newPlot('humidityChart', [{ x: [], y: [], mode: 'lines', line: { color: 'blue' } }], humidityLayout);

    socket.on('new_data', function (data) {
        Plotly.extendTraces('temperatureChart', { x: [[data.time]], y: [[data.temperature]] }, [0]);
        Plotly.extendTraces('humidityChart', { x: [[data.time]], y: [[data.humidity]] }, [0]);

        document.getElementById('currentTemperature').innerText = data.current_temperature.toFixed(2);
        document.getElementById('averageTemperature5Min').innerText = data.average_temperature_5min.toFixed(2);
        document.getElementById('averageTemperature5Days').innerText = data.average_temperature_5days.toFixed(2);
    });

    // Bus schedule logic
    const departures = ["07:30", "08:30", "13:00", "16:40", "17:40"];
    const arrivals = ["08:25", "12:55", "16:35", "17:35"];

    function getNextBus() {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes(); // Minutes since midnight

        for (let i = 0; i < departures.length; i++) {
            const [depHour, depMin] = departures[i].split(':').map(Number);
            const depTime = depHour * 60 + depMin;

            if (depTime >= currentTime) {
                document.getElementById("next-departure").textContent = `Next Departure: ${departures[i]}`;
                document.getElementById("next-arrival").textContent = 
                    arrivals[i] ? `Next Arrival: ${arrivals[i]}` : "Next Arrival: N/A";
                return;
            }
        }

        // If no more buses today, show the first departure of tomorrow
        document.getElementById("next-departure").textContent = `Departure: ${departures[0]} (Tomorrow)`;
        document.getElementById("next-arrival").textContent = 
            arrivals[0] ? `Arrival: ${arrivals[0]}` : "Next Arrival: N/A";
    }

    // Load bus times every 10 minutes (600,000 milliseconds)
    setInterval(getNextBus, 600000); // Adjust interval as needed
    getNextBus(); // Initial load

    function loadBBCNews() {
        fetch('/news')
            .then(response => response.json())
            .then(data => {
                const newsList = document.getElementById('bbcNewsList');
                newsList.innerHTML = '';

                if (data.error) {
                    newsList.innerHTML = `<li>Error loading news: ${data.error}</li>`;
                    return;
                }

                data.forEach(news => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<a href="${news.link}" target="_blank">${news.title}</a>`;
                    newsList.appendChild(listItem);
                });
            })
            .catch(error => {
                console.error('Error fetching news:', error);
            });
    }

    // Load the BBC news on page load
    setInterval(loadBBCNews, 60000);
    loadBBCNews();

    function loadWeather(cityId) {
        fetch(`/weather/${cityId}`)
            .then(response => response.json())
            .then(data => {
                const weatherInfo = document.getElementById('weatherInfo');

                if (data.error) {
                    weatherInfo.innerHTML = `<p>Error loading weather: ${data.error}</p>`;
                    return;
                }

                weatherInfo.innerHTML = `
                    <p>City: ${data.city}</p>
                    <p>Temperature: ${data.temperature} ¬∞C</p>
                    <p>Condition: ${data.description}</p>
                    <img src="http://openweathermap.org/img/wn/${data.icon}.png" alt="${data.description}" />
                `;
            })
            .catch(error => console.error('Error fetching weather:', error));
    }

    // Load weather every 10 minutes (600,000 milliseconds)
    setInterval(() => loadWeather(2644487), 600000); // London city ID
    loadWeather(2644487); // Initial load

    function checkPubTime() {
        const now = new Date();
        const day = now.getDay(); // 5 is Friday (0 = Sunday, 6 = Saturday)
        const hours = now.getHours();

        const isFriday = day === 5;
        const isPubTime = hours >= 17 && hours < 22; // Between 5:00 PM and 10:00 PM

        const pubDiv = document.getElementById('gone-pub');
        if (isFriday && isPubTime) {
            pubDiv.style.display = 'block'; // Show the message
        } else {
            pubDiv.style.display = 'none'; // Hide the message
        }
    }

    // Check every minute if it's pub time (60000 milliseconds)
    setInterval(checkPubTime, 60000);
    checkPubTime(); // Initial check when the page loads


    async function checkMICE() {
        
        
        markers = await (await fetch("https://mcbroken.com/markers.json", {"method": "GET"})).json();
        
        id_map = {
            "macice-p-rust" : {"street": "Ruston Road", "city": "Lincoln"},
            "macice-p-cor"  : {"street": "13/14 Cornhill", "city": "Lincoln"},
            "macice-p-hs"   : {"street": "323 High Street", "city": "Lincoln"},
            "macice-p-carl" : {"street": "The Carlton Centre", "city": "Lincoln"},
            "macice-p-moor" : {"street": "Moorland Close", "city": "Lincoln"}
        }
        
        Object.keys(id_map).forEach(key => {
            vals = id_map[key];

            shop = markers.features.filter(obj => { return (obj.properties.city === vals.city && obj.properties.street === vals.street && obj.properties.country == "UK"); } )[0];
            
            // console.log(`${key} ${JSON.stringify( shop)}`);
            indicator = document.getElementById(key);

            console.log(shop)
            
            switch (shop.properties.dot) {
                case "working":
                    indicator.innerText = "Working";
                    indicator.classList = ["mcice-good"];
                    break;

                case "broken":
                    indicator.innerText = "Broken";
                    indicator.classList = ["mcice-bad"];
                    break;

                case "inactive":
                default:
                    indicator.innerText = "Unknown";
                    indicator.classList = ["mcice-unknown"];
                    break;
            }
            
        });
    }

    // Check every minute the mc status (60000 milliseconds)
    setInterval(checkMICE, 60000);
    checkMICE(); // Initial check when the page loads

    // function loadDepartures() {
    //     fetch('/departures')
    //         .then(response => response.json())
    //         .then(data => {
    //             const departuresList = document.getElementById('departuresList');
    //             departuresList.innerHTML = '';

    //             if (data.error) {
    //                 departuresList.innerHTML = `<li>Error loading departures: ${data.error}</li>`;
    //                 return;
    //             }

    //             data.forEach(departure => {
    //                 const listItem = document.createElement('li');
    //                 listItem.innerHTML = `${departure.flight_number} to ${departure.destination} at ${new Date(departure.departure_time).toLocaleString()}`;
    //                 departuresList.appendChild(listItem);
    //             });
    //         })
    //         .catch(error => {
    //             console.error('Error fetching departures:', error);
    //         });
    // }

    // // Load the departures on page load
    // setInterval(loadDepartures, 60000);
    // loadDepartures();

</script>

</body>
</html>